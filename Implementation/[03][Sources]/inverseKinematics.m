%╭─╮╭─╮╭─╮╱╱╱╱╱╱╱╱╱╭╮╱╭┬─╮╭─╮╭─╮┬─╮┌─╮╭─╮╱╱╱╱╭─╮┬─╮┌─╱╱╱╱╱╱╱╱╱┌─╮╭─╮╱╱╱╱╭─╮╭─╮╭─╮┬─╮┌─╮╭─╮╱╱╱╱╱╱╱╱╱╭┬─╮┬─╮
%  └─╯┴─╯╰┴─╯╰─────────╯╱╰─╯┴──╯╰─╯─╯┴─╯╰┴─╯╰──╯╰─╯─╯──────────╯┴─╯╰┴─╯╰─╯─╯┴─╯╰┴─╯╰─────────╯╱╰─╯┴──╯╰─|
% INVERSE KINEMATICS

function [J] = inverseKinematics()

global robotTopology x_dot

N = size(robotTopology.nodes,1);
M = size(robotTopology.members,1);
connectivity = robotTopology.connectivity;


% Forwards Kinematics
% length of the members are calculated by using the position of the nodes.
% This is the forward kinematics problem. The solution is found by solving
% the following linear system:
%
%                       L = R * x
%
% where L is the vector of member lengths.

% to find the R matrix, we can first calculate the member lengths in the
% reference configuration.

% Now we can find the R matrix by solving the linear system.



% Coordinates
x = sym('x',[1 N]);
y = sym('y',[1 N]);
z = sym('z',[1 N]);
% d = sym('d',[1 M]);

% Coordinates of the nodes
p = transpose([x; y; z]);

% Connectivity matrix
C = zeros(M,N);

for i = 1:M
    C(i,connectivity(i,1)) = 1;
    C(i,connectivity(i,2)) = -1;
end

% Member lengths

d =C*p;
%D = zeros(M,1);
for i = 1:M
    D(i) = norm(d(i,:));
end

% Function valued vector of the member lengths
F = D';

% Jacobian of the member lengths
assume(p ,"real")
J = jacobian(F,[x y z]);

% Substituting the coordinates of the nodes
x_dot = [ robotTopology.nodes(:,1) ; robotTopology.nodes(:,2) ; robotTopology.nodes(:,3) ];

J = subs(J,[x y z],x_dot');

% L = J*x_dot













% R =[(        0.5000*(2*x1 - 2*x2))/((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^0.5000,       -(0.5000*(2*x1 - 2*x2))/((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^0.5000,                                                                                0,                                                                                0,                                                                                0,                                                                                0, (0.5000*(2*y1 - 2*y2))/((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^0.5000, -(0.5000*(2*y1 - 2*y2))/((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^0.5000,                                                                                0,                                                                                0,                                                                                0,                                                                                0, (0.5000*(2*z1 - 2*z2))/((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^0.5000, -(0.5000*(2*z1 - 2*z2))/((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^0.5000,                                                                                0,                                                                                0,                                                                                0,                                                                                0 ;
%                                                                                   0,         (0.5000*(2*x2 - 2*x3))/((x2 - x3)^2 + (y2 - y3)^2 + (z2 - z3)^2)^0.5000, -(0.5000*(2*x2 - 2*x3))/((x2 - x3)^2 + (y2 - y3)^2 + (z2 - z3)^2)^0.5000,                                                                                0,                                                                                0,                                                                                0,                                                                               0,  (0.5000*(2*y2 - 2*y3))/((x2 - x3)^2 + (y2 - y3)^2 + (z2 - z3)^2)^0.5000, -(0.5000*(2*y2 - 2*y3))/((x2 - x3)^2 + (y2 - y3)^2 + (z2 - z3)^2)^0.5000,                                                                                0,                                                                                0,                                                                                0,                                                                               0,  (0.5000*(2*z2 - 2*z3))/((x2 - x3)^2 + (y2 - y3)^2 + (z2 - z3)^2)^0.5000, -(0.5000*(2*z2 - 2*z3))/((x2 - x3)^2 + (y2 - y3)^2 + (z2 - z3)^2)^0.5000,                                                                                0,                                                                                0,                                                                                0 ;
%             (0.5000*(2*x1 - 2*x3))/((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^0.5000,                                                                                0, -(0.5000*(2*x1 - 2*x3))/((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^0.5000,                                                                                0,                                                                                0,                                                                                0, (0.5000*(2*y1 - 2*y3))/((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^0.5000,                                                                                0, -(0.5000*(2*y1 - 2*y3))/((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^0.5000,                                                                                0,                                                                                0,                                                                                0, (0.5000*(2*z1 - 2*z3))/((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^0.5000,                                                                                0, -(0.5000*(2*z1 - 2*z3))/((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^0.5000,                                                                                0,                                                                                0,                                                                                0 ;
%             (0.5000*(2*x1 - 2*x4))/((x1 - x4)^2 + (y1 - y4)^2 + (z1 - z4)^2)^0.5000,                                                                                0,                                                                                0, -(0.5000*(2*x1 - 2*x4))/((x1 - x4)^2 + (y1 - y4)^2 + (z1 - z4)^2)^0.5000,                                                                                0,                                                                                0, (0.5000*(2*y1 - 2*y4))/((x1 - x4)^2 + (y1 - y4)^2 + (z1 - z4)^2)^0.5000,                                                                                0,                                                                                0, -(0.5000*(2*y1 - 2*y4))/((x1 - x4)^2 + (y1 - y4)^2 + (z1 - z4)^2)^0.5000,                                                                                0,                                                                                0, (0.5000*(2*z1 - 2*z4))/((x1 - x4)^2 + (y1 - y4)^2 + (z1 - z4)^2)^0.5000,                                                                                0,                                                                                0, -(0.5000*(2*z1 - 2*z4))/((x1 - x4)^2 + (y1 - y4)^2 + (z1 - z4)^2)^0.5000,                                                                                0,                                                                                0 ;
%             (0.5000*(2*x1 - 2*x5))/((x1 - x5)^2 + (y1 - y5)^2 + (z1 - z5)^2)^0.5000,                                                                                0,                                                                                0,                                                                                0, -(0.5000*(2*x1 - 2*x5))/((x1 - x5)^2 + (y1 - y5)^2 + (z1 - z5)^2)^0.5000,                                                                                0, (0.5000*(2*y1 - 2*y5))/((x1 - x5)^2 + (y1 - y5)^2 + (z1 - z5)^2)^0.5000,                                                                                0,                                                                                0,                                                                                0, -(0.5000*(2*y1 - 2*y5))/((x1 - x5)^2 + (y1 - y5)^2 + (z1 - z5)^2)^0.5000,                                                                                0, (0.5000*(2*z1 - 2*z5))/((x1 - x5)^2 + (y1 - y5)^2 + (z1 - z5)^2)^0.5000,                                                                                0,                                                                                0,                                                                                0, -(0.5000*(2*z1 - 2*z5))/((x1 - x5)^2 + (y1 - y5)^2 + (z1 - z5)^2)^0.5000,                                                                                0 ;
%                                                                                   0,  (0.5000*(2*x2 - 2*x5))/((x2 - x5)^2 + (y2 - y5)^2 + (z2 - z5)^2)^0.5000,                                                                                0,                                                                                0, -(0.5000*(2*x2 - 2*x5))/((x2 - x5)^2 + (y2 - y5)^2 + (z2 - z5)^2)^0.5000,                                                                                0,                                                                               0,  (0.5000*(2*y2 - 2*y5))/((x2 - x5)^2 + (y2 - y5)^2 + (z2 - z5)^2)^0.5000,                                                                                0,                                                                                0, -(0.5000*(2*y2 - 2*y5))/((x2 - x5)^2 + (y2 - y5)^2 + (z2 - z5)^2)^0.5000,                                                                                0,                                                                               0,  (0.5000*(2*z2 - 2*z5))/((x2 - x5)^2 + (y2 - y5)^2 + (z2 - z5)^2)^0.5000,                                                                                0,                                                                                0, -(0.5000*(2*z2 - 2*z5))/((x2 - x5)^2 + (y2 - y5)^2 + (z2 - z5)^2)^0.5000,                                                                                0 ;
%                                                                                   0,  (0.5000*(2*x2 - 2*x6))/((x2 - x6)^2 + (y2 - y6)^2 + (z2 - z6)^2)^0.5000,                                                                                0,                                                                                0,                                                                                0, -(0.5000*(2*x2 - 2*x6))/((x2 - x6)^2 + (y2 - y6)^2 + (z2 - z6)^2)^0.5000,                                                                               0,  (0.5000*(2*y2 - 2*y6))/((x2 - x6)^2 + (y2 - y6)^2 + (z2 - z6)^2)^0.5000,                                                                                0,                                                                                0,                                                                                0, -(0.5000*(2*y2 - 2*y6))/((x2 - x6)^2 + (y2 - y6)^2 + (z2 - z6)^2)^0.5000,                                                                               0,  (0.5000*(2*z2 - 2*z6))/((x2 - x6)^2 + (y2 - y6)^2 + (z2 - z6)^2)^0.5000,                                                                                0,                                                                                0,                                                                                0, -(0.5000*(2*z2 - 2*z6))/((x2 - x6)^2 + (y2 - y6)^2 + (z2 - z6)^2)^0.5000 ;
%                                                                                   0,                                                                                0,  (0.5000*(2*x3 - 2*x6))/((x3 - x6)^2 + (y3 - y6)^2 + (z3 - z6)^2)^0.5000,                                                                                0,                                                                                0, -(0.5000*(2*x3 - 2*x6))/((x3 - x6)^2 + (y3 - y6)^2 + (z3 - z6)^2)^0.5000,                                                                               0,                                                                                0,  (0.5000*(2*y3 - 2*y6))/((x3 - x6)^2 + (y3 - y6)^2 + (z3 - z6)^2)^0.5000,                                                                                0,                                                                                0, -(0.5000*(2*y3 - 2*y6))/((x3 - x6)^2 + (y3 - y6)^2 + (z3 - z6)^2)^0.5000,                                                                               0,                                                                                0,  (0.5000*(2*z3 - 2*z6))/((x3 - x6)^2 + (y3 - y6)^2 + (z3 - z6)^2)^0.5000,                                                                                0,                                                                                0, -(0.5000*(2*z3 - 2*z6))/((x3 - x6)^2 + (y3 - y6)^2 + (z3 - z6)^2)^0.5000 ;
%                                                                                   0,                                                                                0,  (0.5000*(2*x3 - 2*x4))/((x3 - x4)^2 + (y3 - y4)^2 + (z3 - z4)^2)^0.5000, -(0.5000*(2*x3 - 2*x4))/((x3 - x4)^2 + (y3 - y4)^2 + (z3 - z4)^2)^0.5000,                                                                                0,                                                                                0,                                                                               0,                                                                                0,  (0.5000*(2*y3 - 2*y4))/((x3 - x4)^2 + (y3 - y4)^2 + (z3 - z4)^2)^0.5000, -(0.5000*(2*y3 - 2*y4))/((x3 - x4)^2 + (y3 - y4)^2 + (z3 - z4)^2)^0.5000,                                                                                0,                                                                                0,                                                                               0,                                                                                0,  (0.5000*(2*z3 - 2*z4))/((x3 - x4)^2 + (y3 - y4)^2 + (z3 - z4)^2)^0.5000, -(0.5000*(2*z3 - 2*z4))/((x3 - x4)^2 + (y3 - y4)^2 + (z3 - z4)^2)^0.5000,                                                                                0,                                                                                0 ;
%                                                                                   0,                                                                                0,                                                                                0,  (0.5000*(2*x4 - 2*x5))/((x4 - x5)^2 + (y4 - y5)^2 + (z4 - z5)^2)^0.5000, -(0.5000*(2*x4 - 2*x5))/((x4 - x5)^2 + (y4 - y5)^2 + (z4 - z5)^2)^0.5000,                                                                                0,                                                                               0,                                                                                0,                                                                                0,  (0.5000*(2*y4 - 2*y5))/((x4 - x5)^2 + (y4 - y5)^2 + (z4 - z5)^2)^0.5000, -(0.5000*(2*y4 - 2*y5))/((x4 - x5)^2 + (y4 - y5)^2 + (z4 - z5)^2)^0.5000,                                                                                0,                                                                               0,                                                                                0,                                                                                0,  (0.5000*(2*z4 - 2*z5))/((x4 - x5)^2 + (y4 - y5)^2 + (z4 - z5)^2)^0.5000, -(0.5000*(2*z4 - 2*z5))/((x4 - x5)^2 + (y4 - y5)^2 + (z4 - z5)^2)^0.5000,                                                                                0 ;
%                                                                                   0,                                                                                0,                                                                                0,                                                                                0,  (0.5000*(2*x5 - 2*x6))/((x5 - x6)^2 + (y5 - y6)^2 + (z5 - z6)^2)^0.5000, -(0.5000*(2*x5 - 2*x6))/((x5 - x6)^2 + (y5 - y6)^2 + (z5 - z6)^2)^0.5000,                                                                               0,                                                                                0,                                                                                0,                                                                                0,  (0.5000*(2*y5 - 2*y6))/((x5 - x6)^2 + (y5 - y6)^2 + (z5 - z6)^2)^0.5000, -(0.5000*(2*y5 - 2*y6))/((x5 - x6)^2 + (y5 - y6)^2 + (z5 - z6)^2)^0.5000,                                                                               0,                                                                                0,                                                                                0,                                                                                0,  (0.5000*(2*z5 - 2*z6))/((x5 - x6)^2 + (y5 - y6)^2 + (z5 - z6)^2)^0.5000, -(0.5000*(2*z5 - 2*z6))/((x5 - x6)^2 + (y5 - y6)^2 + (z5 - z6)^2)^0.5000 ;
%                                                                                   0,                                                                                0,                                                                                0,  (0.5000*(2*x4 - 2*x6))/((x4 - x6)^2 + (y4 - y6)^2 + (z4 - z6)^2)^0.5000,                                                                                0, -(0.5000*(2*x4 - 2*x6))/((x4 - x6)^2 + (y4 - y6)^2 + (z4 - z6)^2)^0.5000,                                                                               0,                                                                                0,                                                                                0,  (0.5000*(2*y4 - 2*y6))/((x4 - x6)^2 + (y4 - y6)^2 + (z4 - z6)^2)^0.5000,                                                                                0, -(0.5000*(2*y4 - 2*y6))/((x4 - x6)^2 + (y4 - y6)^2 + (z4 - z6)^2)^0.5000,                                                                               0,                                                                                0,                                                                                0,  (0.5000*(2*z4 - 2*z6))/((x4 - x6)^2 + (y4 - y6)^2 + (z4 - z6)^2)^0.5000,                                                                                0, -(0.5000*(2*z4 - 2*z6))/((x4 - x6)^2 + (y4 - y6)^2 + (z4 - z6)^2)^0.5000 ];
% 
% R = sym(R,[x, y, z],in);


